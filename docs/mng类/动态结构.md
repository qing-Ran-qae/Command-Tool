# 动态结构(`ds`)

此工具允许您创建动态的方块结构<br>
但原理是创建并维护很多个展示实体，所以卡顿会较高

**作用**<br>
动态结构并非是只有基本移动方式和只能看到其模型的东西<br>
它支持如下的各种操作：
- 结构预设：结构不可随意创建，必须先创建预设然后根据预设的设定来创建模型和对模型进行操作
- 多级子结构
- 块动画：结构中的方块和子结构支持各种形式的动画，例如改变块实体数据、删除/添加块和移动块的位置等
- 块交互事件：给结构中的块添加鼠标点击和悬停事件
- 碰撞块：可以在结构中添加具有碰撞箱的块来让结构可被玩家"碰到"

**玩法**<br>
因为动态结构中的所有块都是实体<br>
所以您可以使用任意命令对块实体进行操作，包括但不限于修改块位置、块模型、添加/删除块

在此基础上可以实现：
- 一个顶级结构作为"坦克底盘"，其有一个子结构"炮塔"<br>
  炮塔上有一个子结构"舱盖"，其有一个覆盖整个结构的交互块，右键即可"开关"舱盖

## 前置

- [bookshelf](https://github.com/mcbookshelf/Bookshelf)
    - `interaction`模块
- [large_number](https://github.com/kaer-3058/large_number)
    - `large_number:uuid_list_for_hyphen`函数
    - `large_number:uuid_list_for_hyphen/*`函数

## 方法

### 创建结构模板(`create_tmpl`)

创建一个结构模板

**输入**

```
函数宏
*<{}>with
├ *<str>name  - 模板名，长度大于等于1字符，允许除引号以外的任意字符的任意组合
└ *<{}>top_str  - 顶级结构数据，见下文[结构层级数据格式]
```

**返回**

```
无
```

**结构层级数据格式**

```
{
    <str>name  - 结构名，长度大于等于1字符，允许除引号以外任意字符的任意组合
    <int>left front top  - 如果不是顶级结构则使用这三个参数表示此结构的原点相对上级结构原点的位移量
    <{}>groups  - 所有块组
        └ <{}>组名，长度大于等于1字符，允许任意字符的任意组合
            ├ <[{}]>display_blocks  - 所有显示块，显示块仅用于让结构可以被玩家看到
            │    └ 一个显示块，见下文
            ├ <[{}]>hitbox_blocks  - 所有有碰撞箱的块
            │    └ 一个碰撞块，见下文
            └ <[{}]>inter_blocks  - 所有可添加鼠标点击和悬停事件的块
                 └ 一个交互块，见下文
    <[]>sub_str  - 可选项，所有子结构
        └ <{}>  - 一个子结构
    <{}>mgmt  - 可选项，指定维护哪些块的哪些数据
        └ <{}>一个组名
            └ <bool>lr  - 默认为开，是否维护块实体的位置和朝向。关闭后移动函数依然可以正常使用但是如果块实体因未知原因改变位置则不会修正
}
```

**块通用数据**

```
{
    <str>name  - 可选项，块名，长度大于等于1字符，允许除引号以外任意字符的任意组合
    此值用于在创建实例后对块进行操作时索引块，如未指定则无法找到块
    <float|int|str>left front up  - 三个参数，分别表示块相对结构原点的左、前、上偏移量，负值即反向
    <str>run  - 可选项，创建结构实例时创建此块额外执行的命令，执行者和执行位置为块实体
}
```

**显示块数据格式**

```
{
    <str>type  - 显示类型，可选"item"显示物品、"block"或"text"
    <str|{}>nbt  - 自定义块实体(方块/物品/文本展示)数据。格式同summon命令的nbt参数
    必须使用此值为展示实体添加展示的模型，否则显示块不可见
}
```

**碰撞块数据格式**

```
{
    <double>size  - 碰撞箱大小，单位为方块(米)
    <str|{}>nbt  - 可选项，自定义块实体(潜影贝)数据。格式同summon命令的nbt参数
}
```

**交互块数据格式**

```
{
    <float>height  - 交互块高度
    <float>width  - 交互块长、宽度
    <[]>events  - 所有事件
        └─ {}  - 一个事件
            ├ <str>type  - 事件类型，可选以下值：
            │    "left_click"：左键单击
            │    "right_click"：右键单击
            │    "hover"：光标悬停时
            │    "enter_hover"：光标进入
            │    "leave_hover"：光标离开
            ├ <str>run  - 触发事件后执行的一条命令
            └ <{}>macros  - 可选项，自定义bs添加事件函数的传入参数，此项优先级高于run参数
}
```

**示例**

```
function ct:mng/ds/meth/create_tmpl { \
    with: { \
        name: "测试模板", \
        top_str: { \
            name: "顶级结构", \
            groups: { \
                "组": { \
                    display_blocks: [ \
                        {left:1, front:1, up:0, type:"block", nbt:"{block_state:{Name:\"stone\"}}"}, \
                        {left:-1, front:1, up:0, type:"block", nbt:"{block_state:   {Name:\"stone\"}}"}, \
                        {left:1, front:-1, up:0, type:"block", nbt:"{block_state:{Name:\"stone\"}}"}, \
                        {left:-1, front:-1, up:0, type:"block", nbt:"{block_state:{Name:\"stone\"}}"}, \
                    ], \
                    hitbox_blocks: [ \
                        {left:1, front:1, up:0, size:1}, \
                        {left:-1, front:1, up:0, size:1}, \
                        {left:1, front:-1, up:0, size:1}, \
                        {left:-1, front:-1, up:0, size:1}, \
                    ] \
                } \
            } \
        } \
    } \
}
```

### 删除结构模板(`delete_tmpl`)

删除一个结构模板

**输入**

```
函数宏
*<str>tmpl  - 指定一个模板，使用模板名进行索引
```

### 创建结构实例(`create_inst`)

根据指定模板创建一个结构实例

**输入**

```
执行信息
execute at/positioned ... run function this  - 指定结构中顶级结构的原点位置，即在何处实例化结构

函数宏
*<{}>with
├ *<str>name  - 实例名，长度大于等于1字符，允许除引号以外任意字符的任意组合
└ *<str>tmpl  - 指定一个模板，使用模板名进行索引
```

**返回**

```
无
```

### 删除结构实例(`delete_inst`)

删除一个结构实例

**输入**

```
*<str>inst  - 指定一个实例，使用实例名进行索引
```

### 获取结构实例列表(`get_insts`)

**输入**

```
无
```

**返回**

```
储存 ct:data o
└ <[""]>insts  - 所有实例的名称
```

### 获取实例信息(`get_inst`)

获取指定实例的信息

**输入**

```
*<str>inst  - 指定一个实例，使用实例名进行索引
*<[str]>path  - 可选项，值为一个结构路径（格式见下文）
```

**返回**

```
储存 ct:data o
├ <double>x y z y p  - 这5个值分别对应目标实例或结构的坐标和俯仰、偏转角度
│    如果指定了path参数则此项返回path对应结构的原点位置，反之
└ <{}>size  - 如果未指定path参数则此项无内容，反之则返回path对应结构的块数
     ├ <int>display  - 显示块数
     ├ <int>hitbox  - 碰撞块数
     └ <int>inter  - 交互块数
```

### 移动结构(`move_str`)

移动实例或结构

注：如果type参数为`"motion"`会发生上次移动还没结束就开始下次移动，这会导致"是否可以穿墙"将会被新的移动操作设置覆盖

**输入**

```
函数宏
*<{}>with
├ *<str>inst  - 指定一个实例，使用实例名进行索引
├ <[[]]>strs  - 指定所有要移动的结构
│    └ 一个结构路径（格式见下文）
├ *<str>type  - 实现方式，可选以下值：
│    motion：平滑移动，在服务端有真坐标过渡，但不方便精细控制距离
│    tp：没有坐标过渡，但如果显示块的设置合适会有客户端视觉过渡，此外此选项可以很精细的控制移动距离
├ (type:"motion")*<[double]>force  - 对结构施加的力，格式同实体的Motion数据值
└ (type:"motion")<str|bool>wp  - 是否可以穿墙，可选以下值：
    true：布尔型，完全可以穿墙
    whole：字符串，整个结构均不可穿墙，效果类似一辆普通的载具撞到墙后会停下
    origin：字符串，仅结构原点不可穿墙
```

**返回**

```
无
```

## 结构路径数据格式

结构的大概内容在模板中定义，其中就定义了所有结构的上下级关系和结构自己的名称<br>
在使用模板实例化结构之后实例的名称为自定义，其内的所有结构名称均从模板中复制

结构路径用于在指定一个实例后查找实例中的某个结构，其格式为一个列表中包含N个结构名<br>
列表中越靠前的结构名就越上级，反之则越里层<br>
列表的第一个元素只能是实例的顶级结构名

例子：
 - `["foo","bar"]`指定顶级结构`foo`的子结构`bar`
 - `["abc","def","ghi"]`指定顶级结构`foo`的子结构`def`，`def`的子结构`ghi`
 - `["hull","tracks"]`坦克底盘结构（`hull`）中的履带子结构（`tracks`）